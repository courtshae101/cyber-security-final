"0","library(rpart)
by_country <- gapminder %>% 
  group_by(country, continent) %>% 
  nest()

country_model <- function(df) {
  rpart(lifeExp ~ gdpPercap, data = df)
}

models <- map(by_country$data, country_model)

by_country <- by_country %>% 
  mutate(model = map(data, country_model))

by_country %>% 
  arrange(continent, country)
"
"0",""
"0","by_country <- by_country %>% "
"0","  mutate("
"0","    resids = map2(data, model, add_residuals)"
"0","  )"
"0","resids <- unnest(by_country, resids)"
"0",""
"0","resids %>% "
"0","  ggplot(aes(gdpPercap, resid, group = country)) +"
"0","    geom_line(alpha = 1 / 3) + "
"0","    facet_wrap(~continent)"
